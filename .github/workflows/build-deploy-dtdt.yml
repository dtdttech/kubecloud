name: Build and Deploy DTDT Nixidy Manifests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Nix
      uses: cachix/install-nix-action@v30
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        
    - name: Build dtdt manifests
      run: |
        nix build .#dtdt
        
    - name: Prepare manifests for upload
      run: |
        mkdir -p manifests
        rsync -aL --chmod=644 result/* manifests/
        find manifests -type f -name "*:*" -exec bash -c 'mv "$1" "${1//:/--}"' _ {} \;
        
    - name: Upload manifests as artifact
      uses: actions/upload-artifact@v4
      with:
        name: dtdt-kubernetes-manifests
        path: manifests/
        retention-days: 30

  deploy:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download manifests artifact
      uses: actions/download-artifact@v4
      with:
        name: dtdt-kubernetes-manifests
        path: manifests/
        
    - name: Checkout rendered repository
      uses: actions/checkout@v4
      with:
        repository: dtdttech/kubedtdt_rendered
        token: '${{ secrets.RENDERED_DTDT_REPO }}'
        path: rendered-repo
        
    - name: Copy manifests to rendered repository
      run: |
        # Clean existing content in rendered repo
        cd rendered-repo
        find . -type f -not -path './.git/*' -delete
        find . -type d -empty -delete
        
        # Copy new manifests (dereference symlinks)
        cd ..
        cp -rL manifests/* rendered-repo/
        
    - name: Commit and push to rendered repository
      run: |
        cd rendered-repo
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "Update DTDT manifests from kubecloud@${{ github.sha }}
          
          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push
        else
          echo "No changes to commit"
        fi
